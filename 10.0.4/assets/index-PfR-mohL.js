import{_ as p,E as h,T as u,a as f,d as l,b as T}from"./vendor-BC7v46vH.js";function k(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const d="ws://localhost:8435",w=1e3,m=120,c=i=>i instanceof T?{message:i.message,name:i.name,stack:i.stack,statusCode:i.statusCode,statusText:i.statusText}:{message:i.message,name:i.name,stack:i.stack};class A{constructor(){this.addEventListeners(),this.transportType="webhid",this.abortController=null,this.currentOperation=null}createAbortController(){return this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.abortController.signal}checkAborted(){var t;if(["signTransaction","signPersonalMessage","signTypedData"].includes(this.currentOperation)&&((t=this.abortController)!=null&&t.signal.aborted))throw new Error("Operation aborted by user")}async abortCurrentOperation(){this.abortController&&this.abortController.abort(),this.transport&&this.transport.close().catch(e=>{console.log("Transport close error during abort:",e)})}async raceAgainstAbort(e){return Promise.race([e,new Promise((t,a)=>{var s,r;(s=this.abortController)!=null&&s.signal.aborted&&a(new Error("Operation aborted by user")),(r=this.abortController)==null||r.signal.addEventListener("abort",()=>{a(new Error("Operation aborted by user"))})})])}addEventListeners(){window.addEventListener("message",async e=>{if(e&&e.data&&e.data.target==="LEDGER-IFRAME"){const{action:t,params:a,messageId:s}=e.data,r="".concat(t,"-reply");switch(t){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:r,success:!0,messageId:s});break;case"ledger-unlock":this.unlock(r,a.hdPath,s);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",a),this.signTransaction(r,a.hdPath,a.tx,s);break;case"ledger-sign-personal-message":this.signPersonalMessage(r,a.hdPath,a.message,s);break;case"ledger-close-bridge":this.cleanUp(r,s);break;case"ledger-update-transport":a.transportType==="ledgerLive"||a.useLedgerLive?await this.updateTransportTypePreference(r,"ledgerLive",s):a.transportType==="webhid"?this.updateTransportTypePreference(r,"webhid",s):this.updateTransportTypePreference(r,"u2f",s);break;case"ledger-make-app":this.attemptMakeApp(r,s);break;case"ledger-get-app-name-and-version":this.getAppAndName(r,s);break;case"ledger-sign-typed-data":this.signTypedData(r,a.hdPath,a.message,s);break;case"ledger-abort-operation":this.handleAbort(r,s);break}}},!1)}async handleAbort(e,t){console.log("LEDGER:::HANDLE ABORT");try{console.log("LEDGER:::HANDLE ABORT TRY"),await this.abortCurrentOperation(),this.sendMessageToExtension({action:e,success:!0,messageId:t}),console.log("LEDGER:::HANDLE ABORT SENT")}catch(a){console.log("LEDGER:::HANDLE ABORT ERROR",a),this.sendMessageToExtension({action:e,success:!1,payload:{error:c(a)},messageId:t})}}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise(t=>setTimeout(t,e))}checkTransportLoop(e){const t=e||0;return this.checkAborted(),p.check(d).catch(async()=>{if(this.checkAborted(),await this.delay(w),this.checkAborted(),t<m)return this.checkTransportLoop(t+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(e,t){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:t})}catch(a){await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:t,payload:{error:c(a)}})}}async makeApp(e={}){try{if(this.checkAborted(),this.transportType==="ledgerLive"){let t=!1;try{await p.check(d)}catch(a){this.checkAborted(),window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),t=!0}(!this.app||t)&&(this.checkAborted(),this.transport=await p.open(d),this.checkAborted(),this.app=new h(this.transport))}else if(this.transportType==="webhid"){const t=this.transport&&this.transport.device,a=t&&t.constructor.name,s=t&&t.opened;if(this.app&&a==="HIDDevice"&&s)return;this.checkAborted(),this.transport=e.openOnly?await u.openConnected():await u.create(),this.checkAborted(),this.app=new h(this.transport)}else this.checkAborted(),this.transport=await f.create(),this.checkAborted(),this.app=new h(this.transport)}catch(t){throw console.log("LEDGER:::CREATE APP ERROR",t),t}}async getAppAndName(e,t){var a,s;try{await this.makeApp();const r=await this.transport.send(176,1,0,0);if(r[0]!==1)throw new Error("Incorrect format return from getAppNameAndVersion.");let o=1;const n=(a=r[o])!=null?a:0;o+=1;const b=r.slice(o,o+=n).toString(this.transportEncoding),y=(s=r[o])!=null?s:0;o+=1;const E=r.slice(o,o+=y).toString(this.transportEncoding),g={appName:b,version:E};console.log("LEDGER:::GET APP AND NAME",g),this.sendMessageToExtension({action:e,success:!0,payload:g,messageId:t})}catch(r){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(r)},messageId:t})}}async updateTransportTypePreference(e,t,a){this.transportType=t,await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:a})}async cleanUp(e,t){if(this.app=null,this.transport){try{await this.transport.close()}catch(a){console.log("Transport close error during cleanup:",a)}this.transport=null}e&&this.sendMessageToExtension({action:e,success:!0,messageId:t})}async unlock(e,t,a){try{await this.makeApp();const s=await this.app.getAddress(t,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:a})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:a})}finally{this.transportType!=="ledgerLive"&&await this.cleanUp()}}async signTransaction(e,t,a,s){var r;this.currentOperation="signTransaction",this.createAbortController();try{await this.makeApp(),this.checkAborted();const o=await this.raceAgainstAbort(this.app.clearSignTransaction(t,a,{nft:!0,externalPlugins:!0,erc20:!0}));this.sendMessageToExtension({action:e,success:!0,payload:o,messageId:s})}catch(o){const n=o.message==="Operation aborted by user"||((r=this.abortController)==null?void 0:r.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:c(o),aborted:n},messageId:s})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&await this.cleanUp()}}async signPersonalMessage(e,t,a,s){var r;this.currentOperation="signPersonalMessage",this.createAbortController();try{await this.makeApp(),this.checkAborted();const o=await this.raceAgainstAbort(this.app.signPersonalMessage(t,a));this.sendMessageToExtension({action:e,success:!0,payload:o,messageId:s})}catch(o){const n=o.message==="Operation aborted by user"||((r=this.abortController)==null?void 0:r.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:c(o),aborted:n},messageId:s})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&await this.cleanUp()}}async signTypedData(e,t,a,s){var r;this.currentOperation="signTypedData",this.createAbortController();try{await this.makeApp(),this.checkAborted();let o=await this.attemptSignEIP712Message(t,a);this.sendMessageToExtension({action:e,success:!0,payload:o,messageId:s})}catch(o){const n=o.message==="Operation aborted by user"||((r=this.abortController)==null?void 0:r.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:c(o),aborted:n},messageId:s})}finally{this.currentOperation=null,this.abortController=null,await this.cleanUp()}}async attemptSignEIP712Message(e,t){var a;try{return this.checkAborted(),await this.raceAgainstAbort(this.app.signEIP712Message(e,t))}catch(s){if(s.message==="Operation aborted by user")throw s;if((a=this.abortController)!=null&&a.signal.aborted)throw new Error("Operation aborted by user");const r=l.TypedDataUtils.hashStruct("EIP712Domain",t.domain,t.types,l.SignTypedDataVersion.V4).toString("hex"),o=l.TypedDataUtils.hashStruct(t.primaryType,t.message,t.types,l.SignTypedDataVersion.V4).toString("hex");return await this.raceAgainstAbort(this.app.signEIP712HashedMessage(e,r,o))}}ledgerErrToMessage(e){const t=n=>!!n&&!!n.metaData,a=n=>typeof n=="string",s=n=>n.hasOwnProperty("id")&&n.hasOwnProperty("message"),r=n=>String(n.message||n).includes("6804"),o=n=>n.message&&n.message.includes("OpenFailed");return t(e)?e.metaData.code===5?new Error("LEDGER_TIMEOUT"):e.metaData.type:r(e)?new Error("LEDGER_WRONG_APP"):o(e)||a(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):s(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>new A)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{k as __vite_legacy_guard};
