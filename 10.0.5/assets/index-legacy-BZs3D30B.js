System.register(["./vendor-legacy-98DcKUFp.js"],(function(e,t){"use strict";var s,a,r,n,o,i;return{setters:[e=>{s=e._,a=e.E,r=e.T,n=e.a,o=e.d,i=e.b}],execute:function(){const e="ws://localhost:8435",t=e=>e instanceof i?{message:e.message,name:e.name,stack:e.stack,statusCode:e.statusCode,statusText:e.statusText}:{message:e.message,name:e.name,stack:e.stack};class c{constructor(){this.addEventListeners(),this.transportType="webhid",this.abortController=null,this.currentOperation=null}createAbortController(){return this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.abortController.signal}checkAborted(){var e;if(["signTransaction","signPersonalMessage","signTypedData"].includes(this.currentOperation)&&null!==(e=this.abortController)&&void 0!==e&&e.signal.aborted)throw new Error("Operation aborted by user")}async abortCurrentOperation(){this.abortController&&this.abortController.abort(),this.transport&&this.transport.close().catch((e=>{console.log("Transport close error during abort:",e)}))}async raceAgainstAbort(e){return Promise.race([e,new Promise(((e,t)=>{var s,a;null!==(s=this.abortController)&&void 0!==s&&s.signal.aborted&&t(new Error("Operation aborted by user")),null===(a=this.abortController)||void 0===a||a.signal.addEventListener("abort",(()=>{t(new Error("Operation aborted by user"))}))}))])}addEventListeners(){window.addEventListener("message",(async e=>{if(e&&e.data&&"LEDGER-IFRAME"===e.data.target){const{action:t,params:s,messageId:a}=e.data,r=`${t}-reply`;switch(t){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:r,success:!0,messageId:a});break;case"ledger-unlock":this.unlock(r,s.hdPath,a);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",s),this.signTransaction(r,s.hdPath,s.tx,a);break;case"ledger-sign-personal-message":this.signPersonalMessage(r,s.hdPath,s.message,a);break;case"ledger-close-bridge":this.cleanUp(r,a);break;case"ledger-update-transport":"ledgerLive"===s.transportType||s.useLedgerLive?await this.updateTransportTypePreference(r,"ledgerLive",a):"webhid"===s.transportType?this.updateTransportTypePreference(r,"webhid",a):this.updateTransportTypePreference(r,"u2f",a);break;case"ledger-make-app":this.attemptMakeApp(r,a);break;case"ledger-get-app-name-and-version":this.getAppAndName(r,a);break;case"ledger-sign-typed-data":this.signTypedData(r,s.hdPath,s.message,a);break;case"ledger-abort-operation":this.handleAbort(r,a)}}}),!1)}async handleAbort(e,s){console.log("LEDGER:::HANDLE ABORT");try{console.log("LEDGER:::HANDLE ABORT TRY"),await this.abortCurrentOperation(),this.sendMessageToExtension({action:e,success:!0,messageId:s}),console.log("LEDGER:::HANDLE ABORT SENT")}catch(a){console.log("LEDGER:::HANDLE ABORT ERROR",a),this.sendMessageToExtension({action:e,success:!1,payload:{error:t(a)},messageId:s})}}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise((t=>setTimeout(t,e)))}checkTransportLoop(t){const a=t||0;return this.checkAborted(),s.check(e).catch((async()=>{if(this.checkAborted(),await this.delay(1e3),this.checkAborted(),a<120)return this.checkTransportLoop(a+1);throw new Error("Ledger transport check timeout")}))}async attemptMakeApp(e,s){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:s})}catch(a){await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:s,payload:{error:t(a)}})}}async makeApp(t={}){try{if(this.checkAborted(),"ledgerLive"===this.transportType){let t=!1;try{await s.check(e)}catch(o){this.checkAborted(),window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),t=!0}this.app&&!t||(this.checkAborted(),this.transport=await s.open(e),this.checkAborted(),this.app=new a(this.transport))}else if("webhid"===this.transportType){const e=this.transport&&this.transport.device,s=e&&e.constructor.name,n=e&&e.opened;if(this.app&&"HIDDevice"===s&&n)return;this.checkAborted(),this.transport=t.openOnly?await r.openConnected():await r.create(),this.checkAborted(),this.app=new a(this.transport)}else this.checkAborted(),this.transport=await n.create(),this.checkAborted(),this.app=new a(this.transport)}catch(i){throw console.log("LEDGER:::CREATE APP ERROR",i),i}}async getAppAndName(e,s){try{var a,r;await this.makeApp();const t=await this.transport.send(176,1,0,0);if(1!==t[0])throw new Error("Incorrect format return from getAppNameAndVersion.");let n=1;const o=null!==(a=t[n])&&void 0!==a?a:0;n+=1;const i=t.slice(n,n+=o).toString(this.transportEncoding),c=null!==(r=t[n])&&void 0!==r?r:0;n+=1;const l={appName:i,version:t.slice(n,n+=c).toString(this.transportEncoding)};console.log("LEDGER:::GET APP AND NAME",l),this.sendMessageToExtension({action:e,success:!0,payload:l,messageId:s})}catch(n){this.sendMessageToExtension({action:e,success:!1,payload:{error:t(n)},messageId:s})}}async updateTransportTypePreference(e,t,s){this.transportType=t,this.sendMessageToExtension({action:e,success:!0,messageId:s})}async cleanUp(e,t){if(this.app=null,this.transport){try{await this.transport.close()}catch(s){console.log("Transport close error during cleanup:",s)}this.transport=null}e&&this.sendMessageToExtension({action:e,success:!0,messageId:t})}async unlock(e,s,a){try{await this.makeApp();const t=await this.app.getAddress(s,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:a})}catch(r){this.sendMessageToExtension({action:e,success:!1,payload:{error:t(r)},messageId:a})}finally{"ledgerLive"!==this.transportType&&await this.cleanUp()}}async signTransaction(e,s,a,r){this.currentOperation="signTransaction",this.createAbortController();try{await this.makeApp(),this.checkAborted();const t=await this.raceAgainstAbort(this.app.clearSignTransaction(s,a,{nft:!0,externalPlugins:!0,erc20:!0}));this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(o){var n;const s="Operation aborted by user"===o.message||(null===(n=this.abortController)||void 0===n?void 0:n.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:t(o),aborted:s},messageId:r})}finally{this.currentOperation=null,this.abortController=null,"ledgerLive"!==this.transportType&&await this.cleanUp()}}async signPersonalMessage(e,s,a,r){this.currentOperation="signPersonalMessage",this.createAbortController();try{await this.makeApp(),this.checkAborted();const t=await this.raceAgainstAbort(this.app.signPersonalMessage(s,a));this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(o){var n;const s="Operation aborted by user"===o.message||(null===(n=this.abortController)||void 0===n?void 0:n.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:t(o),aborted:s},messageId:r})}finally{this.currentOperation=null,this.abortController=null,"ledgerLive"!==this.transportType&&await this.cleanUp()}}async signTypedData(e,s,a,r){this.currentOperation="signTypedData",this.createAbortController();try{await this.makeApp(),this.checkAborted();let t=await this.attemptSignEIP712Message(s,a);this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(o){var n;const s="Operation aborted by user"===o.message||(null===(n=this.abortController)||void 0===n?void 0:n.signal.aborted);this.sendMessageToExtension({action:e,success:!1,payload:{error:t(o),aborted:s},messageId:r})}finally{this.currentOperation=null,this.abortController=null,await this.cleanUp()}}async attemptSignEIP712Message(e,t){try{return this.checkAborted(),await this.raceAgainstAbort(this.app.signEIP712Message(e,t))}catch(a){var s;if("Operation aborted by user"===a.message)throw a;if(null!==(s=this.abortController)&&void 0!==s&&s.signal.aborted)throw new Error("Operation aborted by user");const r=o.TypedDataUtils.hashStruct("EIP712Domain",t.domain,t.types,o.SignTypedDataVersion.V4).toString("hex"),n=o.TypedDataUtils.hashStruct(t.primaryType,t.message,t.types,o.SignTypedDataVersion.V4).toString("hex");return await this.raceAgainstAbort(this.app.signEIP712HashedMessage(e,r,n))}}ledgerErrToMessage(e){return(e=>!!e&&!!e.metaData)(e)?5===e.metaData.code?new Error("LEDGER_TIMEOUT"):e.metaData.type:(e=>String(e.message||e).includes("6804"))(e)?new Error("LEDGER_WRONG_APP"):(e=>e.message&&e.message.includes("OpenFailed"))(e)||(e=>"string"==typeof e)(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):(e=>e.hasOwnProperty("id")&&e.hasOwnProperty("message"))(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>{new c})(),console.log(`MetaMask < = > Ledger Bridge initialized from ${window.location}!`)}}}));
