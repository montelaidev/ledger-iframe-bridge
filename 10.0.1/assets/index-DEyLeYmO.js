import{_ as d,E as l,T as u,a as T,d as p,b as m}from"./vendor-BC7v46vH.js";function P(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function a(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=a(t);fetch(t.href,s)}})();const h="ws://localhost:8435",w=1e3,L=120,c=o=>o instanceof m?{message:o.message,name:o.name,stack:o.stack,statusCode:o.statusCode,statusText:o.statusText}:{message:o.message,name:o.name,stack:o.stack};class M{constructor(){this.addEventListeners(),this.transportType="u2f"}addEventListeners(){window.addEventListener("message",async e=>{if(e&&e.data&&e.data.target==="LEDGER-IFRAME"){const{action:a,params:n,messageId:t}=e.data,s="".concat(a,"-reply");switch(a){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:s,success:!0,messageId:t});break;case"ledger-unlock":this.unlock(s,n.hdPath,t);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",n),this.signTransaction(s,n.hdPath,n.tx,t);break;case"ledger-sign-personal-message":this.signPersonalMessage(s,n.hdPath,n.message,t);break;case"ledger-close-bridge":this.cleanUp(s,t);break;case"ledger-update-transport":n.transportType==="ledgerLive"||n.useLedgerLive?this.updateTransportTypePreference(s,"ledgerLive",t):n.transportType==="webhid"?this.updateTransportTypePreference(s,"webhid",t):this.updateTransportTypePreference(s,"u2f",t);break;case"ledger-make-app":this.attemptMakeApp(s,t);break;case"ledger-get-app-name-and-version":this.getAppAndName(s,t);break;case"ledger-sign-typed-data":this.signTypedData(s,n.hdPath,n.message,t);break}}},!1)}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise(a=>setTimeout(a,e))}checkTransportLoop(e){const a=e||0;return d.check(h).catch(async()=>{if(await this.delay(w),a<L)return this.checkTransportLoop(a+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(e,a){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:a})}catch(n){await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:a,payload:{error:c(n)}})}}async makeApp(e={}){try{if(this.transportType==="ledgerLive"){let a=!1;try{await d.check(h)}catch(n){window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),a=!0}(!this.app||a)&&(this.transport=await d.open(h),this.app=new l(this.transport))}else if(this.transportType==="webhid"){const a=this.transport&&this.transport.device,n=a&&a.constructor.name,t=a&&a.opened;if(this.app&&n==="HIDDevice"&&t)return;this.transport=e.openOnly?await u.openConnected():await u.create(),this.app=new l(this.transport)}else this.transport=await T.create(),this.app=new l(this.transport)}catch(a){throw console.log("LEDGER:::CREATE APP ERROR",a),a}}async getAppAndName(e,a){var n,t;try{await this.makeApp();const s=await this.transport.send(176,1,0,0);if(s[0]!==1)throw new Error("Incorrect format return from getAppNameAndVersion.");let i=1;const r=(n=s[i])!=null?n:0;i+=1;const f=s.slice(i,i+=r).toString(this.transportEncoding),y=(t=s[i])!=null?t:0;i+=1;const E=s.slice(i,i+=y).toString(this.transportEncoding),g={appName:f,version:E};console.log("LEDGER:::GET APP AND NAME",g),this.sendMessageToExtension({action:e,success:!0,payload:g})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:a})}}updateTransportTypePreference(e,a,n){this.transportType=a,this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:n})}async cleanUp(e,a){this.app=null,this.transport&&(await this.transport.close(),this.transport=null),e&&this.sendMessageToExtension({action:e,success:!0,messageId:a})}async unlock(e,a,n){try{await this.makeApp();const t=await this.app.getAddress(a,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:n})}catch(t){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(t)},messageId:n})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTransaction(e,a,n,t){try{await this.makeApp();const s=await this.app.clearSignTransaction(a,n,{nft:!0,externalPlugins:!0,erc20:!0});this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:t})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:t})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signPersonalMessage(e,a,n,t){try{await this.makeApp();const s=await this.app.signPersonalMessage(a,n);this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:t})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:t})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTypedData(e,a,n,t){try{await this.makeApp();let s=await this.attemptSignEIP712Message(a,n);this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:t})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:t})}finally{this.cleanUp()}}async attemptSignEIP712Message(e,a){try{return await this.app.signEIP712Message(e,a)}catch(n){const t=p.TypedDataUtils.hashStruct("EIP712Domain",a.domain,a.types,p.SignTypedDataVersion.V4).toString("hex"),s=p.TypedDataUtils.hashStruct(a.primaryType,a.message,a.types,p.SignTypedDataVersion.V4).toString("hex");return await this.app.signEIP712HashedMessage(e,t,s)}}ledgerErrToMessage(e){const a=r=>!!r&&!!r.metaData,n=r=>typeof r=="string",t=r=>r.hasOwnProperty("id")&&r.hasOwnProperty("message"),s=r=>String(r.message||r).includes("6804"),i=r=>r.message&&r.message.includes("OpenFailed");return a(e)?e.metaData.code===5?new Error("LEDGER_TIMEOUT"):e.metaData.type:s(e)?new Error("LEDGER_WRONG_APP"):i(e)||n(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):t(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>new M)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{P as __vite_legacy_guard};
