import{_ as p,E as l,T as g,a as E,d as h,b as T}from"./vendor-BC7v46vH.js";function k(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const d="ws://localhost:8435",m=1e3,w=120,c=i=>i instanceof T?{message:i.message,name:i.name,stack:i.stack,statusCode:i.statusCode,statusText:i.statusText}:{message:i.message,name:i.name,stack:i.stack};class A{constructor(){this.addEventListeners(),this.transportType="webhid",this.abortController=null,this.currentOperation=null}createAbortController(){return this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.abortController.signal}checkAborted(){var t;if(["signTransaction","signPersonalMessage","signTypedData"].includes(this.currentOperation)&&((t=this.abortController)!=null&&t.signal.aborted))throw new Error("Operation aborted by user")}async abortCurrentOperation(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.currentOperation=null,await this.cleanUp()}addEventListeners(){window.addEventListener("message",async e=>{if(e&&e.data&&e.data.target==="LEDGER-IFRAME"){const{action:t,params:a,messageId:r}=e.data,s="".concat(t,"-reply");switch(t){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:s,success:!0,messageId:r});break;case"ledger-unlock":this.unlock(s,a.hdPath,r);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",a),this.signTransaction(s,a.hdPath,a.tx,r);break;case"ledger-sign-personal-message":this.signPersonalMessage(s,a.hdPath,a.message,r);break;case"ledger-close-bridge":this.cleanUp(s,r);break;case"ledger-update-transport":a.transportType==="ledgerLive"||a.useLedgerLive?await this.updateTransportTypePreference(s,"ledgerLive",r):a.transportType==="webhid"?this.updateTransportTypePreference(s,"webhid",r):this.updateTransportTypePreference(s,"u2f",r);break;case"ledger-make-app":this.attemptMakeApp(s,r);break;case"ledger-get-app-name-and-version":this.getAppAndName(s,r);break;case"ledger-sign-typed-data":this.signTypedData(s,a.hdPath,a.message,r);break;case"ledger-abort-operation":this.handleAbort(s,r);break}}},!1)}async handleAbort(e,t){try{await this.abortCurrentOperation(),this.sendMessageToExtension({action:e,success:!0,messageId:t})}catch(a){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(a)},messageId:t})}}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise(t=>setTimeout(t,e))}checkTransportLoop(e){const t=e||0;return this.checkAborted(),p.check(d).catch(async()=>{if(this.checkAborted(),await this.delay(m),this.checkAborted(),t<w)return this.checkTransportLoop(t+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(e,t){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:t})}catch(a){await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:t,payload:{error:c(a)}})}}async makeApp(e={}){try{if(this.checkAborted(),this.transportType==="ledgerLive"){let t=!1;try{await p.check(d)}catch(a){this.checkAborted(),window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),t=!0}(!this.app||t)&&(this.checkAborted(),this.transport=await p.open(d),this.checkAborted(),this.app=new l(this.transport))}else if(this.transportType==="webhid"){const t=this.transport&&this.transport.device,a=t&&t.constructor.name,r=t&&t.opened;if(this.app&&a==="HIDDevice"&&r)return;this.checkAborted(),this.transport=e.openOnly?await g.openConnected():await g.create(),this.checkAborted(),this.app=new l(this.transport)}else this.checkAborted(),this.transport=await E.create(),this.checkAborted(),this.app=new l(this.transport)}catch(t){throw console.log("LEDGER:::CREATE APP ERROR",t),t}}async getAppAndName(e,t){var a,r;try{await this.makeApp();const s=await this.transport.send(176,1,0,0);if(s[0]!==1)throw new Error("Incorrect format return from getAppNameAndVersion.");let n=1;const o=(a=s[n])!=null?a:0;n+=1;const y=s.slice(n,n+=o).toString(this.transportEncoding),b=(r=s[n])!=null?r:0;n+=1;const f=s.slice(n,n+=b).toString(this.transportEncoding),u={appName:y,version:f};console.log("LEDGER:::GET APP AND NAME",u),this.sendMessageToExtension({action:e,success:!0,payload:u,messageId:t})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:t})}}async updateTransportTypePreference(e,t,a){this.transportType=t,await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:a})}async cleanUp(e,t){this.app=null,this.transport&&(await this.transport.close(),this.transport=null),e&&this.sendMessageToExtension({action:e,success:!0,messageId:t})}async unlock(e,t,a){try{await this.makeApp();const r=await this.app.getAddress(t,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:r,messageId:a})}catch(r){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(r)},messageId:a})}finally{this.transportType!=="ledgerLive"&&await this.cleanUp()}}async signTransaction(e,t,a,r){this.currentOperation="signTransaction",this.createAbortController();try{await this.makeApp(),this.checkAborted();const s=await this.app.clearSignTransaction(t,a,{nft:!0,externalPlugins:!0,erc20:!0});this.checkAborted(),this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:r})}catch(s){const n=s.message==="Operation aborted by user";this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s),aborted:n},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&this.cleanUp()}}async signPersonalMessage(e,t,a,r){this.currentOperation="signPersonalMessage",this.createAbortController();try{await this.makeApp(),this.checkAborted();const s=await this.app.signPersonalMessage(t,a);this.checkAborted(),this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:r})}catch(s){const n=s.message==="Operation aborted by user";this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s),aborted:n},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTypedData(e,t,a,r){this.currentOperation="signTypedData",this.createAbortController();try{await this.makeApp(),this.checkAborted();let s=await this.attemptSignEIP712Message(t,a);this.checkAborted(),this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:r})}catch(s){const n=s.message==="Operation aborted by user";this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s),aborted:n},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.cleanUp()}}async attemptSignEIP712Message(e,t){try{return this.checkAborted(),await this.app.signEIP712Message(e,t)}catch(a){if(a.message==="Operation aborted by user")throw a;this.checkAborted();const r=h.TypedDataUtils.hashStruct("EIP712Domain",t.domain,t.types,h.SignTypedDataVersion.V4).toString("hex"),s=h.TypedDataUtils.hashStruct(t.primaryType,t.message,t.types,h.SignTypedDataVersion.V4).toString("hex");return this.checkAborted(),await this.app.signEIP712HashedMessage(e,r,s)}}ledgerErrToMessage(e){const t=o=>!!o&&!!o.metaData,a=o=>typeof o=="string",r=o=>o.hasOwnProperty("id")&&o.hasOwnProperty("message"),s=o=>String(o.message||o).includes("6804"),n=o=>o.message&&o.message.includes("OpenFailed");return t(e)?e.metaData.code===5?new Error("LEDGER_TIMEOUT"):e.metaData.type:s(e)?new Error("LEDGER_WRONG_APP"):n(e)||a(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):r(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>new A)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{k as __vite_legacy_guard};
