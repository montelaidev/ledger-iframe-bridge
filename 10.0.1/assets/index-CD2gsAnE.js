import{_ as d,E as l,T as g,a as u,d as p,b as y}from"./vendor-BC7v46vH.js";function m(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const h="ws://localhost:8435",f=1e3,E=120,c=i=>i instanceof y?{message:i.message,name:i.name,stack:i.stack,statusCode:i.statusCode,statusText:i.statusText}:{message:i.message,name:i.name,stack:i.stack};class T{constructor(){this.addEventListeners(),this.transportType="u2f"}addEventListeners(){window.addEventListener("message",async e=>{if(e&&e.data&&e.data.target==="LEDGER-IFRAME"){const{action:t,params:n,messageId:s}=e.data,a="".concat(t,"-reply");switch(t){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:a,success:!0,messageId:s});break;case"ledger-unlock":this.unlock(a,n.hdPath,s);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",n),this.signTransaction(a,n.hdPath,n.tx,s);break;case"ledger-sign-personal-message":this.signPersonalMessage(a,n.hdPath,n.message,s);break;case"ledger-close-bridge":this.cleanUp(a,s);break;case"ledger-update-transport":n.transportType==="ledgerLive"||n.useLedgerLive?this.updateTransportTypePreference(a,"ledgerLive",s):n.transportType==="webhid"?this.updateTransportTypePreference(a,"webhid",s):this.updateTransportTypePreference(a,"u2f",s);break;case"ledger-make-app":this.attemptMakeApp(a,s);break;case"ledger-get-app-name-and-version":this.getAppAndName(a,s);break;case"ledger-sign-typed-data":this.signTypedData(a,n.hdPath,n.message,s);break}}},!1)}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise(t=>setTimeout(t,e))}checkTransportLoop(e){const t=e||0;return d.check(h).catch(async()=>{if(await this.delay(f),t<E)return this.checkTransportLoop(t+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(e,t){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:t})}catch(n){await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:t,payload:{error:c(n)}})}}async makeApp(e={}){try{if(this.transportType==="ledgerLive"){let t=!1;try{await d.check(h)}catch(n){window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),t=!0}(!this.app||t)&&(this.transport=await d.open(h),this.app=new l(this.transport))}else if(this.transportType==="webhid"){const t=this.transport&&this.transport.device,n=t&&t.constructor.name,s=t&&t.opened;if(this.app&&n==="HIDDevice"&&s)return;this.transport=e.openOnly?await g.openConnected():await g.create(),this.app=new l(this.transport)}else this.transport=await u.create(),this.app=new l(this.transport)}catch(t){throw console.log("LEDGER:::CREATE APP ERROR",t),t}}async getAppAndName(e,t){try{await this.makeApp(),console.log("LEDGER:::GET APP AND NAME",this.transport);const s=(await transport.send(224,1,0,0)).slice(0,-2),a=s.toString("ascii").replace(/\x00/g,""),o=s.slice(s.length-2).toString("hex"),r={appName:a,version:o};console.log("LEDGER:::GET APP AND NAME",r),this.sendMessageToExtension({action:e,success:!0,payload:r})}catch(n){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(n)},messageId:t})}}updateTransportTypePreference(e,t,n){this.transportType=t,this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:n})}async cleanUp(e,t){this.app=null,this.transport&&(await this.transport.close(),this.transport=null),e&&this.sendMessageToExtension({action:e,success:!0,messageId:t})}async unlock(e,t,n){try{await this.makeApp();const s=await this.app.getAddress(t,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:s,messageId:n})}catch(s){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(s)},messageId:n})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTransaction(e,t,n,s){try{await this.makeApp();const a=await this.app.clearSignTransaction(t,n,{nft:!0,externalPlugins:!0,erc20:!0});this.sendMessageToExtension({action:e,success:!0,payload:a,messageId:s})}catch(a){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(a)},messageId:s})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signPersonalMessage(e,t,n,s){try{await this.makeApp();const a=await this.app.signPersonalMessage(t,n);this.sendMessageToExtension({action:e,success:!0,payload:a,messageId:s})}catch(a){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(a)},messageId:s})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTypedData(e,t,n,s){try{await this.makeApp();let a=await this.attemptSignEIP712Message(t,n);this.sendMessageToExtension({action:e,success:!0,payload:a,messageId:s})}catch(a){this.sendMessageToExtension({action:e,success:!1,payload:{error:c(a)},messageId:s})}finally{this.cleanUp()}}async attemptSignEIP712Message(e,t){try{return await this.app.signEIP712Message(e,t)}catch(n){const s=p.TypedDataUtils.hashStruct("EIP712Domain",t.domain,t.types,p.SignTypedDataVersion.V4).toString("hex"),a=p.TypedDataUtils.hashStruct(t.primaryType,t.message,t.types,p.SignTypedDataVersion.V4).toString("hex");return await this.app.signEIP712HashedMessage(e,s,a)}}ledgerErrToMessage(e){const t=r=>!!r&&!!r.metaData,n=r=>typeof r=="string",s=r=>r.hasOwnProperty("id")&&r.hasOwnProperty("message"),a=r=>String(r.message||r).includes("6804"),o=r=>r.message&&r.message.includes("OpenFailed");return t(e)?e.metaData.code===5?new Error("LEDGER_TIMEOUT"):e.metaData.type:a(e)?new Error("LEDGER_WRONG_APP"):o(e)||n(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):s(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>new T)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{m as __vite_legacy_guard};
