import{_ as p,E as h,T as g,a as m,d as l,b as T}from"./vendor-BC7v46vH.js";function A(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(r){if(r.ep)return;r.ep=!0;const t=s(r);fetch(r.href,t)}})();const u="ws://localhost:8435",w=1e3,O=120,c=i=>i instanceof T?{message:i.message,name:i.name,stack:i.stack,statusCode:i.statusCode,statusText:i.statusText}:{message:i.message,name:i.name,stack:i.stack};class b{constructor(){this.addEventListeners(),this.transportType="webhid",this.abortController=null,this.currentOperation=null}addEventListeners(){window.addEventListener("message",async e=>{if(e&&e.data&&e.data.target==="LEDGER-IFRAME"){const{action:s,params:n,messageId:r}=e.data,t="".concat(s,"-reply");switch(s){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:t,success:!0,messageId:r});break;case"ledger-unlock":this.unlock(t,n.hdPath,r);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",n),this.signTransaction(t,n.hdPath,n.tx,r);break;case"ledger-sign-personal-message":this.signPersonalMessage(t,n.hdPath,n.message,r);break;case"ledger-close-bridge":this.cleanUp(t,r);break;case"ledger-update-transport":n.transportType==="ledgerLive"||n.useLedgerLive?await this.updateTransportTypePreference(t,"ledgerLive",r):n.transportType==="webhid"?this.updateTransportTypePreference(t,"webhid",r):this.updateTransportTypePreference(t,"u2f",r);break;case"ledger-make-app":this.attemptMakeApp(t,r);break;case"ledger-get-app-name-and-version":this.getAppAndName(t,r);break;case"ledger-sign-typed-data":this.signTypedData(t,n.hdPath,n.message,r);break}}},!1)}sendMessageToExtension(e){window.parent.postMessage(e,"*")}delay(e){return new Promise(s=>setTimeout(s,e))}cancelOngoingOperation(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.currentOperation=null}checkTransportLoop(e){const s=e||0;return p.check(u).catch(async()=>{if(await this.delay(w),s<O)return this.checkTransportLoop(s+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(e,s){this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="attemptMakeApp";try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:s})}catch(n){if(n.name==="AbortError")return;await this.cleanUp(),this.sendMessageToExtension({action:e,success:!1,messageId:s,payload:{error:c(n)}})}finally{this.currentOperation=null,this.abortController=null}}async makeApp(e={}){try{if(this.transportType==="ledgerLive"){let s=!1;try{await p.check(u)}catch(n){window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),s=!0}(!this.app||s)&&(this.transport=await p.open(u),this.app=new h(this.transport))}else if(this.transportType==="webhid"){const s=this.transport&&this.transport.device,n=s&&s.constructor.name,r=s&&s.opened;if(this.app&&n==="HIDDevice"&&r)return;this.transport=e.openOnly?await g.openConnected():await g.create(),this.app=new h(this.transport)}else this.transport=await m.create(),this.app=new h(this.transport)}catch(s){throw console.log("LEDGER:::CREATE APP ERROR",s),s}}async getAppAndName(e,s){var n,r;this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="getAppAndName";try{await this.makeApp();const t=await this.transport.send(176,1,0,0);if(t[0]!==1)throw new Error("Incorrect format return from getAppNameAndVersion.");let o=1;const a=(n=t[o])!=null?n:0;o+=1;const f=t.slice(o,o+=a).toString(),y=(r=t[o])!=null?r:0;o+=1;const E=t.slice(o,o+=y).toString(),d={appName:f,version:E};console.log("LEDGER:::GET APP AND NAME",d),this.sendMessageToExtension({action:e,success:!0,payload:d,messageId:s})}catch(t){if(t.name==="AbortError")return;this.sendMessageToExtension({action:e,success:!1,payload:{error:c(t)},messageId:s})}finally{this.currentOperation=null,this.abortController=null}}async updateTransportTypePreference(e,s,n){this.currentOperation&&this.cancelOngoingOperation(),this.transportType=s,await this.cleanUp(),this.sendMessageToExtension({action:e,success:!0,messageId:n})}async cleanUp(e,s){this.cancelOngoingOperation(),this.app=null,this.transport&&(await this.transport.close(),this.transport=null),e&&this.sendMessageToExtension({action:e,success:!0,messageId:s})}async unlock(e,s,n){this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="unlock";try{await this.makeApp();const r=await this.app.getAddress(s,!1,!0);this.sendMessageToExtension({action:e,success:!0,payload:r,messageId:n})}catch(r){if(r.name==="AbortError")return;this.sendMessageToExtension({action:e,success:!1,payload:{error:c(r)},messageId:n})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&await this.cleanUp()}}async signTransaction(e,s,n,r){this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="signTransaction";try{await this.makeApp();const t=await this.app.clearSignTransaction(s,n,{nft:!0,externalPlugins:!0,erc20:!0});this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(t){if(t.name==="AbortError")return;this.sendMessageToExtension({action:e,success:!1,payload:{error:c(t)},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&this.cleanUp()}}async signPersonalMessage(e,s,n,r){this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="signPersonalMessage";try{await this.makeApp();const t=await this.app.signPersonalMessage(s,n);this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(t){if(t.name==="AbortError")return;this.sendMessageToExtension({action:e,success:!1,payload:{error:c(t)},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTypedData(e,s,n,r){this.currentOperation&&this.cancelOngoingOperation(),this.abortController=new AbortController,this.currentOperation="signTypedData";try{await this.makeApp();let t=await this.attemptSignEIP712Message(s,n);this.sendMessageToExtension({action:e,success:!0,payload:t,messageId:r})}catch(t){if(t.name==="AbortError")return;this.sendMessageToExtension({action:e,success:!1,payload:{error:c(t)},messageId:r})}finally{this.currentOperation=null,this.abortController=null,this.cleanUp()}}async attemptSignEIP712Message(e,s){if(this.abortController&&this.abortController.signal.aborted)throw new Error("Operation cancelled");try{return await this.app.signEIP712Message(e,s)}catch(n){if(this.abortController&&this.abortController.signal.aborted)throw new Error("Operation cancelled");const r=l.TypedDataUtils.hashStruct("EIP712Domain",s.domain,s.types,l.SignTypedDataVersion.V4).toString("hex"),t=l.TypedDataUtils.hashStruct(s.primaryType,s.message,s.types,l.SignTypedDataVersion.V4).toString("hex");return await this.app.signEIP712HashedMessage(e,r,t)}}ledgerErrToMessage(e){const s=a=>!!a&&!!a.metaData,n=a=>typeof a=="string",r=a=>a.hasOwnProperty("id")&&a.hasOwnProperty("message"),t=a=>String(a.message||a).includes("6804"),o=a=>a.message&&a.message.includes("OpenFailed");return s(e)?e.metaData.code===5?new Error("LEDGER_TIMEOUT"):e.metaData.type:t(e)?new Error("LEDGER_WRONG_APP"):o(e)||n(e)&&e.includes("6801")?new Error("LEDGER_LOCKED"):r(e)&&e.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):e}}(async()=>new b)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{A as __vite_legacy_guard};
