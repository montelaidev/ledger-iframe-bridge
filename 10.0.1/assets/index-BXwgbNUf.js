import{_ as d,E as l,T as u,a as m,d as p,b as w}from"./vendor-BC7v46vH.js";function x(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function s(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(e){if(e.ep)return;e.ep=!0;const n=s(e);fetch(e.href,n)}})();const h="ws://localhost:8435",L=1e3,M=120,c=i=>i instanceof w?{message:i.message,name:i.name,stack:i.stack,statusCode:i.statusCode,statusText:i.statusText}:{message:i.message,name:i.name,stack:i.stack};class P{constructor(){this.addEventListeners(),this.transportType="u2f"}addEventListeners(){window.addEventListener("message",async t=>{if(t&&t.data&&t.data.target==="LEDGER-IFRAME"){const{action:s,params:a,messageId:e}=t.data,n="".concat(s,"-reply");switch(s){case"ledger-is-iframe-ready":this.sendMessageToExtension({action:n,success:!0,messageId:e});break;case"ledger-unlock":this.unlock(n,a.hdPath,e);break;case"ledger-sign-transaction":console.log("ledger-sign-transaction",a),this.signTransaction(n,a.hdPath,a.tx,e);break;case"ledger-sign-personal-message":this.signPersonalMessage(n,a.hdPath,a.message,e);break;case"ledger-close-bridge":this.cleanUp(n,e);break;case"ledger-update-transport":a.transportType==="ledgerLive"||a.useLedgerLive?this.updateTransportTypePreference(n,"ledgerLive",e):a.transportType==="webhid"?this.updateTransportTypePreference(n,"webhid",e):this.updateTransportTypePreference(n,"u2f",e);break;case"ledger-make-app":this.attemptMakeApp(n,e);break;case"ledger-get-app-name-and-version":this.getAppAndName(n,e);break;case"ledger-sign-typed-data":this.signTypedData(n,a.hdPath,a.message,e);break}}},!1)}sendMessageToExtension(t){window.parent.postMessage(t,"*")}delay(t){return new Promise(s=>setTimeout(s,t))}checkTransportLoop(t){const s=t||0;return d.check(h).catch(async()=>{if(await this.delay(L),s<M)return this.checkTransportLoop(s+1);throw new Error("Ledger transport check timeout")})}async attemptMakeApp(t,s){try{await this.makeApp({openOnly:!0}),await this.cleanUp(),this.sendMessageToExtension({action:t,success:!0,messageId:s})}catch(a){await this.cleanUp(),this.sendMessageToExtension({action:t,success:!1,messageId:s,payload:{error:c(a)}})}}async makeApp(t={}){try{if(this.transportType==="ledgerLive"){let s=!1;try{await d.check(h)}catch(a){window.open("ledgerlive://bridge?appName=Ethereum"),await this.checkTransportLoop(),s=!0}(!this.app||s)&&(this.transport=await d.open(h),this.app=new l(this.transport))}else if(this.transportType==="webhid"){const s=this.transport&&this.transport.device,a=s&&s.constructor.name,e=s&&s.opened;if(this.app&&a==="HIDDevice"&&e)return;this.transport=t.openOnly?await u.openConnected():await u.create(),this.app=new l(this.transport)}else this.transport=await m.create(),this.app=new l(this.transport)}catch(s){throw console.log("LEDGER:::CREATE APP ERROR",s),s}}async getAppAndName(t,s){try{await this.makeApp();const a=await this.transport.send(176,1,0,0);let e=0;const n=a[e++];invariant(n===1,"getAppAndVersion: format not supported");const o=a[e++],r=a.slice(e,e+=o).toString("ascii"),f=a[e++],y=a.slice(e,e+=f).toString("ascii"),E=a[e++],T=a.slice(e,e+=E),g={name:r,version:y,flags:T};console.log("LEDGER:::GET APP AND NAME",g),this.sendMessageToExtension({action:t,success:!0,payload:g})}catch(a){this.sendMessageToExtension({action:t,success:!1,payload:{error:c(a)},messageId:s})}}updateTransportTypePreference(t,s,a){this.transportType=s,this.cleanUp(),this.sendMessageToExtension({action:t,success:!0,messageId:a})}async cleanUp(t,s){this.app=null,this.transport&&(await this.transport.close(),this.transport=null),t&&this.sendMessageToExtension({action:t,success:!0,messageId:s})}async unlock(t,s,a){try{await this.makeApp();const e=await this.app.getAddress(s,!1,!0);this.sendMessageToExtension({action:t,success:!0,payload:e,messageId:a})}catch(e){this.sendMessageToExtension({action:t,success:!1,payload:{error:c(e)},messageId:a})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTransaction(t,s,a,e){try{await this.makeApp();const n=await this.app.clearSignTransaction(s,a,{nft:!0,externalPlugins:!0,erc20:!0});this.sendMessageToExtension({action:t,success:!0,payload:n,messageId:e})}catch(n){this.sendMessageToExtension({action:t,success:!1,payload:{error:c(n)},messageId:e})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signPersonalMessage(t,s,a,e){try{await this.makeApp();const n=await this.app.signPersonalMessage(s,a);this.sendMessageToExtension({action:t,success:!0,payload:n,messageId:e})}catch(n){this.sendMessageToExtension({action:t,success:!1,payload:{error:c(n)},messageId:e})}finally{this.transportType!=="ledgerLive"&&this.cleanUp()}}async signTypedData(t,s,a,e){try{await this.makeApp();let n=await this.attemptSignEIP712Message(s,a);this.sendMessageToExtension({action:t,success:!0,payload:n,messageId:e})}catch(n){this.sendMessageToExtension({action:t,success:!1,payload:{error:c(n)},messageId:e})}finally{this.cleanUp()}}async attemptSignEIP712Message(t,s){try{return await this.app.signEIP712Message(t,s)}catch(a){const e=p.TypedDataUtils.hashStruct("EIP712Domain",s.domain,s.types,p.SignTypedDataVersion.V4).toString("hex"),n=p.TypedDataUtils.hashStruct(s.primaryType,s.message,s.types,p.SignTypedDataVersion.V4).toString("hex");return await this.app.signEIP712HashedMessage(t,e,n)}}ledgerErrToMessage(t){const s=r=>!!r&&!!r.metaData,a=r=>typeof r=="string",e=r=>r.hasOwnProperty("id")&&r.hasOwnProperty("message"),n=r=>String(r.message||r).includes("6804"),o=r=>r.message&&r.message.includes("OpenFailed");return s(t)?t.metaData.code===5?new Error("LEDGER_TIMEOUT"):t.metaData.type:n(t)?new Error("LEDGER_WRONG_APP"):o(t)||a(t)&&t.includes("6801")?new Error("LEDGER_LOCKED"):e(t)&&t.message.includes("U2F not supported")?new Error("U2F_NOT_SUPPORTED"):t}}(async()=>new P)();console.log("MetaMask < = > Ledger Bridge initialized from ".concat(window.location,"!"));export{x as __vite_legacy_guard};
